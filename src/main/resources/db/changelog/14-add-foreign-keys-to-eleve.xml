<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <!-- Étape 1: Ajouter classe_id comme NULLABLE -->
    <changeSet id="014-01-add-classe-id-to-eleve-nullable" author="ecole">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="eleve" columnName="classe_id"/>
            </not>
        </preConditions>
        <addColumn tableName="eleve">
            <column name="classe_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- Étape 2: Mettre à jour avec la première classe disponible -->
    <changeSet id="014-02-update-eleve-classe-id" author="ecole">
        <sql>
            UPDATE eleve 
            SET classe_id = (SELECT MIN(id) FROM classe)
            WHERE classe_id IS NULL;
        </sql>
    </changeSet>

    <!-- Étape 3: Ajouter la contrainte NOT NULL -->
    <changeSet id="014-03-add-not-null-constraint-eleve-classe" author="ecole">
        <addNotNullConstraint tableName="eleve" columnName="classe_id" columnDataType="BIGINT"/>
    </changeSet>

    <!-- Étape 4: Ajouter la clé étrangère -->
    <changeSet id="014-04-add-foreign-key-eleve-classe" author="ecole">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_eleve_classe"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
            baseTableName="eleve"
            baseColumnNames="classe_id"
            constraintName="fk_eleve_classe"
            referencedTableName="classe"
            referencedColumnNames="id"
            onDelete="CASCADE"
            onUpdate="CASCADE"/>
    </changeSet>

    <!-- Étape 5: Ajouter ecole_id comme NULLABLE -->
    <changeSet id="014-05-add-ecole-id-to-eleve-nullable" author="ecole">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="eleve" columnName="ecole_id"/>
            </not>
        </preConditions>
        <addColumn tableName="eleve">
            <column name="ecole_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- Étape 6: Mettre à jour avec la première école disponible -->
    <changeSet id="014-06-update-eleve-ecole-id" author="ecole">
        <sql>
            UPDATE eleve 
            SET ecole_id = (SELECT MIN(id) FROM ecole)
            WHERE ecole_id IS NULL;
        </sql>
    </changeSet>

    <!-- Étape 7: Ajouter la contrainte NOT NULL -->
    <changeSet id="014-07-add-not-null-constraint-eleve-ecole" author="ecole">
        <addNotNullConstraint tableName="eleve" columnName="ecole_id" columnDataType="BIGINT"/>
    </changeSet>

    <!-- Étape 8: Ajouter la clé étrangère -->
    <changeSet id="014-08-add-foreign-key-eleve-ecole" author="ecole">
        <preConditions onFail="MARK_RAN">
            <not>
                <foreignKeyConstraintExists foreignKeyName="fk_eleve_ecole"/>
            </not>
        </preConditions>
        <addForeignKeyConstraint
            baseTableName="eleve"
            baseColumnNames="ecole_id"
            constraintName="fk_eleve_ecole"
            referencedTableName="ecole"
            referencedColumnNames="id"
            onDelete="CASCADE"
            onUpdate="CASCADE"/>
    </changeSet>

    <!-- Étape 9: Créer des index pour la performance -->
    <changeSet id="014-09-create-indexes-eleve" author="ecole">
        <createIndex indexName="idx_eleve_classe_id" tableName="eleve">
            <column name="classe_id"/>
        </createIndex>
        <createIndex indexName="idx_eleve_ecole_id" tableName="eleve">
            <column name="ecole_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
